<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="gl-matrix.js"></script>
  <script type="text/javascript" src="webgl-utils.js"></script>
  <meta charset="utf-8">
  <title>Music Visualizer</title>
  <link rel="stylesheet" href="./webgl.css" type="text/css">
 

  <!-- Main Shader -->
  
  <script id="shader-fs" type="x-shader/x-fragment">
    #define LIGHTNUM 10
    precision mediump float;

    varying vec2 vTextureCoord;
    varying vec3 vTransformedNormal;
    varying vec4 vPosition;
    //varying vec3 vLightRay[LIGHTNUM];
    //varying vec3 vLightDirection[LIGHTNUM];

    uniform vec3 uAmbientColor;

    uniform int lightCount;
    uniform vec4 uColor;
    uniform vec3 uLightLocation[LIGHTNUM];
    uniform vec3 uSpotDirection[LIGHTNUM];
    uniform float spotCosCutoff;

    uniform vec3 uLightSpecularColor;
    uniform vec3 uLightDiffuseColor;
    uniform bool uHasTexure;

    uniform sampler2D uSampler;
    uniform sampler2D diffuseRamp;
    uniform sampler2D specularRamp;
    
    uniform float uMaterialShininess;

    const float spotExponent = 40.0;
    //const float spotCosCutoff = 0.5;   // corresponds to 14 degrees

    vec3 lightWeighting = vec3( 0.0, 0.0, 0.0 );
    vec4 fragmentColor;
    float spotEffect, rdotv, specularLightWeighting, diffuseLightWeighting;
    const float lightAttenuation = 0.01;
    void main(void) 
    {
      float attenuation = 1.0;
      float z = gl_FragCoord.z / gl_FragCoord.w;
      for(int i=0; i<LIGHTNUM; ++i)
      {
          if(i>=lightCount)
            break;
          vec3 vectorToLightSource = normalize(uLightLocation[i] - vPosition.xyz / vPosition.w);
          diffuseLightWeighting = max(0.5 * dot(vTransformedNormal, vectorToLightSource), 0.0) + 0.5;
          float distanceToLight = length(uLightLocation[i] - vPosition.xyz / vPosition.w);
          attenuation = 1.0 / (1.0 + lightAttenuation * distanceToLight*distanceToLight);

          if (diffuseLightWeighting > 0.0) {
              spotEffect = dot(normalize(uSpotDirection[i]), normalize(-vectorToLightSource));
              if (spotEffect > spotCosCutoff) {
                  spotEffect = pow(spotEffect, spotExponent);
                  vec3 reflectionVector = normalize(reflect(-vectorToLightSource, vTransformedNormal));
                  vec3 viewVectorEye = -normalize(vPosition.xyz / vPosition.w);
                  rdotv = max(dot(reflectionVector, viewVectorEye), 0.0);
                  specularLightWeighting = pow(rdotv, uMaterialShininess);
                  vec3 diffuseColor = texture2D(diffuseRamp, vec2(diffuseLightWeighting, 0)).xyz;
                  vec3 specularColor = texture2D(specularRamp, vec2(specularLightWeighting, 0)).xyz;
                  lightWeighting +=attenuation*(spotEffect * diffuseColor +spotEffect * specularColor);
                }
            }
        }

      
      lightWeighting += uAmbientColor;
      if(uHasTexure){
        vec4 fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);
        gl_FragColor = mix(gl_FragColor, vec4(uColor.rgb * lightWeighting, uColor.a), 0.5);
      }
      else{
        gl_FragColor = vec4(uColor.rgb * lightWeighting, uColor.a);
      }
    }
  </script>

  <script id="shader-vs" type="x-shader/x-vertex">
    #define LIGHTNUM 10
    precision mediump float;
    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    uniform mat3 uNMatrix;
    //uniform vec3 uLightLocation[LIGHTNUM];
    //uniform vec3 uSpotDirection[LIGHTNUM];
   
    varying vec2 vTextureCoord;
    varying vec3 vTransformedNormal;
    varying vec4 vPosition;
    varying vec4 vColor;
    //varying vec3 vLightRay[LIGHTNUM];
    //varying vec3 vLightDirection[LIGHTNUM];

    void main(void) {
       // for(int i=0; i < 1; i++)
       // {
            //vec4 lightPosition = uMVMatrix *vec4(uLightLocation[i], 1.0);
            //vLightRay[i]=lightPosition.xyz;
           // vec4 lightDirection =  uMVMatrix *vec4(uSpotDirection[i], 1.0);
            //vLightDirection[i] = lightDirection.xyz;
      //      vLightRay[i]=uLightLocation[i];
      //      vLightDirection[i]  = uSpotDirection[i];
      //  }
        vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);
        gl_Position = uPMatrix * vPosition;
        vTextureCoord = aTextureCoord;
        vTransformedNormal = uNMatrix * aVertexNormal;
        
    }
  </script>
     
  <script type='text/javascript' src='webgl-obj-loader.js'></script>
  <script type='text/javascript' src='globals.js'></script>
  <script type='text/javascript' src='helpers.js'></script>
  <script type='text/javascript' src='initialize.js'></script>
  <script type='text/javascript' src='camera.js'></script>
  <script type='text/javascript' src='scene.js'></script>
  <script type='text/javascript' src='webgl.js'></script>
</head>

<body style='padding:0; margin:0 auto;'>
    <canvas id="mycanvas" style="margin:0 auto;" width="1080" height="675"></canvas><br />
</body>

</html>